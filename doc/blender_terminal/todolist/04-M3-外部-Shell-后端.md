# M3 - 外部 Shell 后端（bash/sh/PowerShell）

对应：`PLAN.md` -> `### M3 - 外部 Shell 后端（bash/sh/PowerShell）`

## 阶段目标

- 在目标平台上提供至少一个可用 shell 后端（优先 Windows PowerShell）。
- 确保：
  - 不阻塞 UI
  - 输出可读
  - 崩溃可恢复
  - 默认安全（避免误执行风险）

## 输入/前置条件

- M2 的终端抽象层已稳定（或至少有可用的接口边界）。

## 交付物（阶段级）

- 至少一个 shell 后端可用
- 后端切换入口与配置

## To-Do

### 1. 现状评估：审查 `_console_shell.py` 并决定是否保留

- [ ] **任务说明**：明确当前实现的限制（非交互、依赖 bash banner 等）并给出保留/替换策略。

#### 交付物

- 一份评估记录：
  - 现状行为
  - 已知问题（Windows 无 bash、非交互、编码等）
  - 建议方案（保留 + 修补 / 重写 / 新增并逐步替代）

#### 测试/验收

- 在 Windows 上验证：当前 banner/execute 是否可用，问题可复现且有记录。

---

### 2. 确定第一目标平台与第一后端

- [ ] **任务说明**：明确首选组合（例如 Windows + PowerShell），并列出后续扩展路线。

#### 交付物

- `TARGET_MATRIX.md`（可选）：平台/后端/优先级/依赖（ConPTY/pty）。

#### 验收

- 明确“第一可用版本”定义：
  - 支持的命令类型
  - 交互能力边界（先行模式 or 真交互）

---

### 3. 进程与 I/O 模型设计（避免阻塞 UI）

- [ ] **任务说明**：设计子进程创建、异步读写、编码处理、退出清理。

#### 交付物

- 一份 I/O 设计文档（含线程/任务调度策略）：
  - 是否需要 PTY（交互式）
  - 非阻塞读取与批量追加 scrollback
  - 编码策略（UTF-8/系统编码）

#### 交付检查

- 明确：
  - UI 主线程绝不做阻塞读取
  - 输出追加有节流（例如每 16~50ms 合并一次）

#### 测试/验收（手工）

- 连续执行输出很多的命令：
  - Blender UI 不冻结
  - 输出顺序正确

---

### 4. 输出渲染能力补齐（ANSI 等）

- [ ] **任务说明**：至少做到“去控制字符不乱码”，再逐步支持颜色。

#### 交付物

- ANSI 处理策略文档
- 实现（最小可用）

#### 测试/验收

- 执行会产生 ANSI 输出的命令（或模拟输出）：
  - 最低要求：不出现大量 `\x1b[` 乱码
  - 高阶：颜色可读（如实现）

---

### 5. 会话状态（cwd/env）与清理重置

- [ ] **任务说明**：确保 per-session cwd/env 不污染 Blender 全局。

#### 交付物

- 会话状态说明与实现

#### 测试/验收

- 创建两个 Console 区域/会话：
  - 在 A 会话 `cd` 不影响 B 会话
  - 关闭会话后进程被正确回收

---

### 6. 安全与开关（默认禁用/实验开关）

- [ ] **任务说明**：默认禁用 shell 后端或置于实验开关下；多行粘贴执行策略与 M1 对齐。

#### 交付物

- 配置项/偏好设置
- 风险提示文案

#### 测试/验收

- 默认安装/默认设置下，不会意外启用 shell 执行
- 启用后，粘贴多行不会自动执行（或必须确认）

---

## 阶段验收标准（汇总）

- 在目标平台上：
  - 输入/输出不阻塞 UI
  - 基本命令可执行、输出可读
  - shell 进程崩溃/退出后可恢复（可重启会话）
