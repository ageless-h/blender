# M4 - 面向艺术家的对话式 AI 助手（增量集成）

对应：`PLAN.md` -> `### M4 - 面向艺术家的对话式 AI 助手（增量集成）`

## 阶段目标

- 以“最小侵入”为原则，把 AI 助手作为外挂模块集成进 Blender。
- 阶段 1：复用 Console（`language='ai'`）快速验证闭环。
- 阶段 2：独立 Editor（自定义 Space Type）实现终极体验。

## 输入/前置条件

- M2 的抽象层与 M1 的交互规则稳定。
- 已明确安全与权限边界（写操作需确认，可撤销）。

## 交付物（阶段级）

- 最小 AI 助手对话原型（可开关）
- 工具接口与权限/安全策略

## To-Do

### 1. 交付形态（方案 C）落地：边界与降级策略

- [ ] **任务说明**：定义本地 Python 包与 Agent 进程边界，并设计缺失/失败时的降级。

#### 交付物

- 一份边界文档：
  - Blender Add-on（薄集成层）职责
  - 本地 Python 包职责（bpy 深度交互、tool host）
  - Agent 进程职责（LLM/Planning/记忆/工具编排）
- 降级策略说明：
  - 无本地包
  - 无 Agent
  - Agent 启动失败/崩溃/超时

#### 测试/验收（手工）

- 在以下场景 UI 表现可解释：
  - 未安装外挂模块：Console 正常使用，无报错
  - 禁用 Add-on：AI 入口不可见或不生效
  - Agent 启动失败：有明确提示，可重试，不阻塞 UI

---

### 2. stdio JSON-RPC 协议定义（最小可用）

- [ ] **任务说明**：定义 framing、握手、流式输出、取消/超时、tool-call。

#### 交付物

- 协议文档（建议包含示例消息）：
  - `Content-Length` framing
  - initialize/handshake
  - streaming 输出分片
  - cancel/timeout
  - tool-call request/response

#### 交付检查

- 协议必须定义：
  - 错误码/错误类型
  - 背压策略（输出太快时如何处理）
  - 版本号与兼容策略

#### 测试/验收

- 用 mock agent（可用最简单的 echo server）验证：
  - 能握手
  - 能流式输出
  - 能取消

---

### 3. 阶段 1：复用 Console（`language='ai'`）最小闭环

- [ ] **任务说明**：实现 `_console_ai.py` 与 Add-on 管理进程，把输入路由到 Agent，输出写入 scrollback。

#### 交付物

- `_console_ai.py`：实现 `execute/autocomplete/banner/copy_as_script` 的最小闭环
- Add-on：
  - spawn/退出/崩溃重启
  - 日志收集
  - 输入路由
  - 输出节流/批量追加

#### 交付检查

- 最小交互要求：
  - 明确区分 USER/ASSISTANT 消息块（前缀或类型）
  - Agent 崩溃/超时/协议错误可解释
  - 不阻塞 UI

#### 测试/验收（手工）

- 发送 10 条消息：
  - UI 不冻结
  - 输出顺序正确
- 触发取消：
  - 能中断长回复
  - Console 可继续输入
- 模拟 Agent 崩溃：
  - 有提示
  - 可重启

---

### 4. 定义“艺术家工作流”用例集合（用例驱动能力范围）

- [ ] **任务说明**：至少定义 10 个用例，覆盖场景/对象/材质/渲染/引导操作。

#### 交付物

- `USE_CASES.md`（可选）

#### 验收

- 每个用例包含：
  - 用户目标
  - AI 需要读取的上下文
  - 可能的工具调用
  - 输出形式（解释/步骤/可撤销动作列表）

---

### 5. 设计工具接口（Tooling）与权限模型

- [ ] **任务说明**：定义只读工具、受限写工具、严格禁止项；写操作需确认并可撤销。

#### 交付物

- `TOOLING.md`（可选）

#### 测试/验收

- 至少完成 1 个“只读 + 建议输出”闭环。
- 至少完成 1 个“受限写 + 用户确认 + Undo 可撤销”闭环。

---

### 6. 阶段 2：独立 Editor（`SpaceAgent`）评估与原型

- [ ] **任务说明**：评估成本与收益，逐步实现富交互（Markdown、Diff/预览、分组/折叠/搜索）。

#### 交付物

- 评估文档 + 原型计划

#### 测试/验收

- 原型至少验证：
  - 富文本渲染不会明显拖慢 UI
  - 写操作前可展示差异并要求确认

---

## 阶段验收标准（汇总）

- **安全模式默认开启**：
  - 重要写操作需要明确确认
  - 行为可撤销/可追溯
- **最小侵入保证**：
  - 未安装外挂模块时，Blender 启动与 Console 使用不受影响
  - 禁用 Add-on 后入口不可见或不生效
  - Blender 主仓库不引入外挂模块硬依赖
- **混合模式保证**：
  - 仅本地 Python 包：至少一个只读用例闭环
  - 启用 Agent：支持 streaming + tool-call + 取消，且 UI 不阻塞
