# M1 - Python Console 体验增强（不改变整体架构）

对应：`PLAN.md` -> `### M1 - Python Console 体验增强（不改变整体架构）`

## 阶段目标

- 不改变 Console 的“整体架构定位”，优先修复/增强用户直接感知的编辑与输出体验。
- 把多行相关行为变得**可预期**且**默认安全**。

## 输入/前置条件

- M0 的手工测试清单已建立，可用作回归。

## 交付物（阶段级）

- 增强后的 Python Console（最好具备可回退开关/配置项）
- 覆盖关键场景的测试用例/手工验证步骤

## To-Do

### 1. 明确“多行编辑”的目标形态（方案 A / 方案 B）

- [x] **任务说明**：先做决策文档，明确采用方案 A 还是 B，或分阶段推进。

#### 交付物

- 一份决策文档：
  - 方案 A：保持单行编辑，但改善多行粘贴/多行执行交互
  - 方案 B：真正的多行编辑缓冲区（涉及数据结构/绘制/Operator）

#### 交付检查

- 文档必须回答：
  - 用户粘贴多行时默认会发生什么（执行/不执行/预览/确认）
  - 用户如何显式执行多行（快捷键/按钮/确认对话）
  - 失败/取消/撤销如何表现

#### 测试/验收

- 使用 M0 的“多行粘贴”用例验证：
  - 默认不会发生“意外多次执行”
  - 用户能清楚看到将执行的次数/范围
  - 取消不会污染历史/scrollback

---

### 2. 设计并实现“历史搜索/过滤”

- [x] **任务说明**：实现 Ctrl+R 反向搜索或等价交互（可先简化实现）。

#### 交付物

- 新的交互入口（快捷键/菜单/面板）与对应实现。
- 文档：
  - 搜索范围（history vs scrollback）
  - 匹配规则（前缀/包含/正则）

#### 交付检查

- 至少支持：
  - 打开/退出搜索
  - 上/下一个匹配
  - 选中结果回填到当前输入行

#### 测试/验收（手工）

- 准备历史：输入 10 条不同命令。
- 触发搜索：
  - 输入关键词能匹配到预期命令
  - 反复 next/prev 不崩溃、不乱码
  - 确认选中后当前输入行正确更新

---

### 3. 增强编辑快捷键一致性（对齐 Text Editor 习惯）

- [ ] **任务说明**：补齐/对齐 Home/End、Ctrl+Backspace 等行为。

#### 交付物

- 更新后的 keymap/operator 行为（尽量复用已有编辑系统）。

#### 交付检查

- 至少覆盖：
  - Home/End
  - Ctrl+Left/Right（按词移动）
  - Ctrl+Backspace / Ctrl+Delete（按词删除）

#### 测试/验收（手工）

- 输入：`foo_bar baz.qux`
- 验证：
  - 按词移动与删除边界符合预期
  - 与 Text Editor 的行为差异（如有）被记录并合理解释

---

### 4. 粘贴大文本的安全策略

- [x] **任务说明**：默认不自动执行多行/大文本；提供设置项或确认弹窗。

#### 交付物

- 一个明确的策略：
  - 默认行为
  - 可配置项
  - UI 提示

#### 交付检查

- 文案与交互必须清楚表达：
  - 本次粘贴将产生多少行
  - 是否会执行
  - 执行前是否需要确认

#### 测试/验收（手工）

- 粘贴 50 行文本：
  - UI 不冻结
  - 不会意外执行
  - 仍可选择/复制/撤销

---

### 5. 输出体验：长输出不卡顿 + 输出分组

- [ ] **任务说明**：优化 scrollback 追加与绘制策略，必要时引入节流/分页/折叠；并按一次执行聚合 INPUT/OUTPUT/ERROR。

#### 交付物

- 输出分组规则文档
- 相关实现

#### 交付检查

- 至少满足：
  - 长输出（例如 5k~50k 行）可阅读
  - 滚动与选择不会明显卡顿（定义一个可量化基线）
  - 分组后复制某次执行输出方便

#### 测试/验收（手工）

- 执行产生大量输出的脚本（可用 Python 循环打印模拟）：
  - UI 仍可响应
  - 输出不会乱序
  - 选择/复制正确

---

### 6. 质量与兼容性验证（输入法/剪贴板/性能基线）

- [ ] **任务说明**：补齐 Windows/macOS/Linux 的差异记录，并在目标平台建立最小性能基线。

#### 交付物

- `MANUAL_TESTS.md` 更新（新增 M1 相关回归）
- `PERF_BASELINE.md`（可选）

#### 测试/验收

- Windows 下输入法：中英文切换、候选上屏不乱
- 剪贴板：跨应用复制粘贴一致
- 性能：scrollback 很长时，滚动与输入延迟在可接受范围（需定义）
