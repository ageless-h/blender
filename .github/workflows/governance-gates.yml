name: Governance Gates

on:
  pull_request:
    branches:
      - main
      - work/milestone-a
      - work/milestone-bc
      - work/milestone-d
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  conformance_gate:
    name: Conformance Gate
    runs-on: ubuntu-latest
    steps:
      - name: Verify conformance evidence checkbox
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Conformance Gate only runs on pull_request events.');
              return;
            }
            const body = pr.body || '';
            const required = /- \[x\] Conformance gate evidence included\./i;
            if (!required.test(body)) {
              core.setFailed('Missing checked item: "Conformance gate evidence included." in PR template.');
            }

  security_gate:
    name: Security Gate
    runs-on: ubuntu-latest
    steps:
      - name: Verify security evidence checkbox
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Security Gate only runs on pull_request events.');
              return;
            }
            const body = pr.body || '';
            const required = /- \[x\] Security gate evidence included\./i;
            if (!required.test(body)) {
              core.setFailed('Missing checked item: "Security gate evidence included." in PR template.');
            }

  performance_gate:
    name: Performance Gate
    runs-on: ubuntu-latest
    steps:
      - name: Verify performance evidence checkbox
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Performance Gate only runs on pull_request events.');
              return;
            }
            const body = pr.body || '';
            const required = /- \[x\] Performance gate evidence included\./i;
            if (!required.test(body)) {
              core.setFailed('Missing checked item: "Performance gate evidence included." in PR template.');
            }

  accessibility_gate:
    name: Accessibility Gate
    runs-on: ubuntu-latest
    steps:
      - name: Verify accessibility evidence checkbox
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Accessibility Gate only runs on pull_request events.');
              return;
            }
            const body = pr.body || '';
            const required = /- \[x\] Accessibility gate evidence included\./i;
            if (!required.test(body)) {
              core.setFailed('Missing checked item: "Accessibility gate evidence included." in PR template.');
            }
