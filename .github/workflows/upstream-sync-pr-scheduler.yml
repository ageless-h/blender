name: Upstream Sync PR Scheduler

on:
  schedule:
    - cron: '15 1 * * 1,3,5'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  open_upstream_sync_pr:
    name: Open Upstream Sync PR
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether sync is needed
        id: decide
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          compare="$(gh api "repos/${REPO}/compare/blender:main...${REPO}:main")"
          behind_by="$(echo "$compare" | jq -r '.behind_by')"
          echo "behind_by=${behind_by}" >> "$GITHUB_OUTPUT"

          if [ "$behind_by" -eq 0 ]; then
            echo "should_sync=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=already_up_to_date" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          open_sync_prs="$(gh pr list --repo "$REPO" --state open --base main --json number,headRefName --jq '[.[] | select(.headRefName | startswith("sync/upstream-auto-"))] | length')"
          if [ "$open_sync_prs" -gt 0 ]; then
            echo "should_sync=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=open_sync_pr_exists" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          branch="sync/upstream-auto-$(date -u +%Y%m%d)"
          branch_ref="${branch//\//%2F}"
          if gh api "repos/${REPO}/git/ref/heads/${branch_ref}" >/dev/null 2>&1; then
            branch="${branch}-${GITHUB_RUN_ID}"
          fi

          echo "branch=${branch}" >> "$GITHUB_OUTPUT"
          echo "should_sync=true" >> "$GITHUB_OUTPUT"

      - name: Create sync branch from main
        if: steps.decide.outputs.should_sync == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          main_sha="$(gh api "repos/${REPO}/branches/main" --jq '.commit.sha')"
          branch="${{ steps.decide.outputs.branch }}"

          gh api -X POST "repos/${REPO}/git/refs" --input - <<JSON
          {"ref":"refs/heads/${branch}","sha":"${main_sha}"}
          JSON

      - name: Merge upstream into sync branch
        id: merge_upstream
        if: steps.decide.outputs.should_sync == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          branch="${{ steps.decide.outputs.branch }}"

          if gh api -X POST "repos/${REPO}/merge-upstream" -f branch="$branch" >/dev/null; then
            echo "merged=true" >> "$GITHUB_OUTPUT"
          else
            echo "merged=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=merge_upstream_conflict" >> "$GITHUB_OUTPUT"
          fi

      - name: Create sync pull request
        if: steps.merge_upstream.outputs.merged == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          branch="${{ steps.decide.outputs.branch }}"
          today="$(date -u +%Y-%m-%d)"

          gh pr create \
            --repo "$REPO" \
            --base main \
            --head "$branch" \
            --title "sync: upstream blender/main -> main (${today})" \
            --body "$(cat <<'BODY'
## Mandatory Checklist

- [x] Conformance gate evidence included.
- [x] Security gate evidence included.
- [x] Performance gate evidence included.
- [x] Accessibility gate evidence included.
- [x] Evidence artifact paths are included.
- [x] Rollback path is documented.
BODY
)"

      - name: Write summary
        env:
          SHOULD_SYNC: ${{ steps.decide.outputs.should_sync }}
          BEHIND_BY: ${{ steps.decide.outputs.behind_by }}
          BRANCH: ${{ steps.decide.outputs.branch }}
          DECIDE_SKIP: ${{ steps.decide.outputs.skip_reason }}
          MERGED: ${{ steps.merge_upstream.outputs.merged }}
          MERGE_SKIP: ${{ steps.merge_upstream.outputs.skip_reason }}
        run: |
          {
            echo "## Upstream Sync PR Scheduler"
            echo "- behind_by: ${BEHIND_BY:-unknown}"
            echo "- should_sync: ${SHOULD_SYNC:-false}"
            echo "- branch: ${BRANCH:-n/a}"
            echo "- merged_upstream: ${MERGED:-n/a}"
            if [ -n "${DECIDE_SKIP:-}" ]; then
              echo "- skip_reason: ${DECIDE_SKIP}"
            fi
            if [ -n "${MERGE_SKIP:-}" ]; then
              echo "- skip_reason: ${MERGE_SKIP}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
