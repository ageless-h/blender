name: Upstream Sync PR Scheduler

on:
  workflow_dispatch: {}
  schedule:
    - cron: '15 1 * * 1,3,5'

permissions:
  contents: write
  pull-requests: write

jobs:
  open_upstream_sync_pr:
    name: Open Upstream Sync PR
    runs-on: ubuntu-latest
    steps:
      - name: Create sync PR when upstream is ahead
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const compare = await github.request('GET /repos/{owner}/{repo}/compare/{basehead}', {
              owner,
              repo,
              basehead: `blender:main...${owner}:main`,
            });

            const behindBy = compare.data.behind_by;
            if (behindBy === 0) {
              core.notice('No upstream drift. Skip creating PR.');
              return;
            }

            const openPulls = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: 'main',
              per_page: 100,
            });

            const hasOpenSyncPr = openPulls.data.some((pr) =>
              pr.head.ref.startsWith('sync/upstream-auto-')
            );
            if (hasOpenSyncPr) {
              core.notice('Open upstream sync PR already exists.');
              return;
            }

            const ymd = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            let branch = `sync/upstream-auto-${ymd}`;

            try {
              await github.rest.git.getRef({ owner, repo, ref: `heads/${branch}` });
              branch = `${branch}-${context.runId}`;
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            const mainRef = await github.rest.git.getRef({ owner, repo, ref: 'heads/main' });
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${branch}`,
              sha: mainRef.data.object.sha,
            });

            try {
              await github.request('POST /repos/{owner}/{repo}/merge-upstream', {
                owner,
                repo,
                branch,
              });
            } catch (error) {
              if (error.status === 409) {
                core.warning('merge-upstream conflict; manual sync required.');
                return;
              }
              throw error;
            }

            const today = new Date().toISOString().slice(0, 10);
            const body = [
              '## Mandatory Checklist',
              '',
              '- [x] Conformance gate evidence included.',
              '- [x] Security gate evidence included.',
              '- [x] Performance gate evidence included.',
              '- [x] Accessibility gate evidence included.',
              '- [x] Evidence artifact paths are included.',
              '- [x] Rollback path is documented.',
            ].join('\n');

            await github.rest.pulls.create({
              owner,
              repo,
              base: 'main',
              head: branch,
              title: `sync: upstream blender/main -> main (${today})`,
              body,
            });

            core.notice(`Created upstream sync PR from ${branch}.`);
